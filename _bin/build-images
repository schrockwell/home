#!/usr/bin/env bash
set -euo pipefail

THUMB_WIDTH=480
FULL_WIDTH=2000

THUMB_QUALITY=82
FULL_QUALITY=88

# Mild sharpening for thumbnails only (radiusxsigma+gain+threshold)
THUMB_UNSHARP="1x0.8+1.0+0.02"

shopt -s nullglob nocaseglob

# Find all image files in _images directories, excluding build artifacts
find . -type f \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o -iname '*.webp' \) \
  -path '*/_images/*' \
  ! -path './_site/*' \
  ! -path './.git/*' \
  ! -path './vendor/*' \
| while read -r src; do
  # Extract the directory containing _images and the filename
  # e.g., ./hw/metar/_images/hero.jpeg -> dir=./hw/metar, file=hero.jpeg
  src_dir="${src%/_images/*}"
  src_file="${src##*/}"

  full_dst="$src_dir/images/full/$src_file"
  thumb_dst="$src_dir/images/thumb/$src_file"

  # Skip if both outputs are newer than source
  if [[ -f "$full_dst" && "$full_dst" -nt "$src" && -f "$thumb_dst" && "$thumb_dst" -nt "$src" ]]; then
    echo "skip  $src"
    continue
  fi

  echo "build $src"

  mkdir -p "$src_dir/images/full" "$src_dir/images/thumb"

  # Full size — auto-orient, resize only if wider than FULL_WIDTH, strip metadata
  magick "$src" \
    -auto-orient \
    -resize "${FULL_WIDTH}x>" \
    -quality "$FULL_QUALITY" \
    -strip \
    "$full_dst"

  # Thumbnail — auto-orient, resize, sharpen, strip metadata
  magick "$src" \
    -auto-orient \
    -resize "${THUMB_WIDTH}x>" \
    -unsharp "$THUMB_UNSHARP" \
    -quality "$THUMB_QUALITY" \
    -strip \
    "$thumb_dst"
done
